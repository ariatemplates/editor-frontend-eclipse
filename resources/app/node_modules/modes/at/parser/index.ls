require! {
# -------------------------------------------------------------------------- 3rd
	_: lodash
# -------------------------------------------------------------------------- App
	'modes/js'
	pegParser: 'pegjs-parser/parser'
# ------------------------------------------------------------------------ Input
	parser: './grammar'
	htmlParser: 'modes/html/parser'
}
# ------------------------------------------------------------------ Extractions

{Parser:PEGParser} = pegParser



class Parser extends PEGParser
	~> super parser

	/**
	 * Parses parts of the model left unparsed.
	 *
	 * These parts are :
	 * - statement parameters, which are most of the time JavaScript expressions, except for a few exceptions like `foreach`
	 * - free text block, which are for now considered to be HTML
	 */
	post-process: (graph) ->
		# @_parse-statement-params graph
		# @_parse-free-text
		graph

	_parse-statement-params: (graph) ->
		statements = _.filter graph.flat, (.type.element in <[ inline opening ]>)
		for statement in statements => @_parse-statement-param statement

	_parse-statement-param: (statement) ->
		param = statement.get 'param'
		node = js.parse(param, 'Expression').body.0 # JS parser uses Mozilla Parser AST format, with the first node always being a root Program, having a list of elements in his body, here there is always only 1 element
		console.log param
		console.log node
		console.log!

	_parse-free-text: (graph) ->
		graph.traverse (node) -> if node.type.element is 'block'
			htmlNodes = _.filter node.children, (.type.element is null)
			htmlValue = [child.properties.value for child in htmlNodes] * ''
			node.add 'html' htmlParser.parse htmlValue



module.exports = Parser!
