require! {
# -------------------------------------------------------------------------- STD
	fs
	util
	path
# -------------------------------------------------------------------------- 3rd
	_: lodash
}
# ------------------------------------------------------------------ Extractions
{readFileSync:read} = fs



################################################################################
# Logger
################################################################################

class Logger
	~>
		@ <<< {
			console-width: 80
		}

	stringify: util.inspect _, {+colors, depth: null, -showHidden}
	log: console.log



	separator: -> @log '-' * @console-width

	align: (input, width, char = ' ') ->
		input = "#input"
		"#input#{"#char" * (width - input.length)}"



	ast: -> @log @stringify it

	exception: ({name, offset, line, column, message, found, expected}) -> @log """
		#name at L#line, C#column (#offset): #message
			- found: #found
			- expected: #expected
	"""

	/**
	 * @todo For column display:
	 * - handle tabs, which are 1 character long but 4 spaces wide
	 * - display other vertical digits
	 * - display the exact number of columns, not the one rouded up to the nearest ten
	 * - fix the first column ,to make it start a 1 instead of 0
	 */
	source: (source) ->
		lines = source.split /\r?\n/g
		maxNumberWidth = "#{lines.length}".length
		for line, index in lines => @log "#{@align index + 1, maxNumberWidth} #line"

		digits = [0 to 9] * ''
		maxlength = _.sortBy lines, (.length) .reverse!0.length
		@log maxlength
		width = Math.round(maxlength / digits.length)
		width = 80 / digits.length
		@log "#{' ' * maxNumberWidth} #{"#digits" * width}"




################################################################################
# Test
################################################################################

basePath = path.dirname module.parent.filename

logger = new Logger!

module.exports = (spec) ->
	{
		parserPath ? '.'
		path, encoding
		loggingMode
		max-source-length
	} = spec
	parser = require "#basePath/#parserPath"
	source = read "#basePath/#path", encoding

	try
		ast = parser.parse source
		output = switch loggingMode
		| 'simplified' => ast.simplify!
		| 'simpletree' => ast.simpleTree!
		| 'raw' => ast
		logger.ast output
	catch exception
		if typeof! exception is 'Error' => console.log exception
		else
			logger.exception exception
			if source.length < max-source-length
				logger.separator!
				logger.source source
				logger.separator!

